---
// Newsletter component for Kit integration
const { 
  title = "Stay Updated with New Book Summaries",
  subtitle = "Get notified when we publish new AI-powered book summaries. Join thousands of readers saving time with our insights.",
  placeholder = "Enter your email address",
  buttonText = "Subscribe Now",
  variant = "default" // "default", "compact", "inline"
} = Astro.props;
---

<!-- Newsletter Section -->
<section class={`newsletter-section ${variant === 'compact' ? 'py-6 sm:py-8' : 'py-12 sm:py-16'} ${variant === 'inline' ? 'bg-transparent' : 'bg-gradient-to-br from-primary-50 to-accent-50'}`}>
  <div class={`max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 ${variant === 'compact' ? 'text-center' : ''}`}>
    <div class={`${variant === 'inline' ? 'flex flex-col md:flex-row items-center gap-4 sm:gap-6' : 'text-center'}`}>
      <!-- Content -->
      <div class={`${variant === 'inline' ? 'flex-1' : 'mb-6 sm:mb-8'}`}>
        <h3 class={`${variant === 'compact' ? 'text-lg sm:text-xl' : 'text-xl sm:text-2xl md:text-3xl'} font-bold text-gray-900 mb-3 sm:mb-4 mobile-large-heading`}>
          {title}
        </h3>
        <p class={`${variant === 'compact' ? 'text-sm sm:text-base' : 'text-base sm:text-lg'} text-gray-600 ${variant === 'inline' ? 'mb-0' : 'mb-4 sm:mb-6'} max-w-2xl ${variant === 'inline' ? '' : 'mx-auto'} px-4 sm:px-0 mobile-large-text`}>
          {subtitle}
        </p>
      </div>
      
      <!-- ConvertKit HTML Embed -->
      <script src="https://f.convertkit.com/ckjs/ck.5.js"></script>
      <form action="https://app.kit.com/forms/8405196/subscriptions" 
            class="seva-form formkit-form" 
            method="post" 
            data-sv-form="8405196" 
            data-uid="be4036594b" 
            data-format="inline" 
            data-version="5" 
            data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;}},&quot;version&quot;:&quot;5&quot;}" 
            min-width="400 500 600 700 800">
        <!-- ConvertKit generated markup -->
        <div data-style="clean">
          <ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul>
          <div data-element="fields" data-stacked="false" class="seva-fields formkit-fields">
            <input class="formkit-input" name="email_address" aria-label="Email Address" placeholder="Email Address" required type="email">
            <button data-element="submit" class="formkit-submit formkit-submit">
              <div class="formkit-spinner"><div></div><div></div><div></div></div>
              <span>Subscribe</span>
            </button>
          </div>
          <div class="formkit-powered-by-convertkit-container">
            <a href="https://kit.com/features/forms?utm_campaign=poweredby&amp;utm_content=form&amp;utm_medium=referral&amp;utm_source=dynamic" data-element="powered-by" class="formkit-powered-by-convertkit" target="_blank" rel="nofollow">Built with Kit</a>
          </div>
        </div>
        <style>
          /* Begin ConvertKit form styling */
          .formkit-form[data-uid="be4036594b"] *{box-sizing:border-box;} 
          .formkit-form[data-uid="be4036594b"]{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;} 
          .formkit-form[data-uid="be4036594b"] legend{border:none;font-size:inherit;margin-bottom:10px;padding:0;position:relative;display:table;} 
          .formkit-form[data-uid="be4036594b"] fieldset{border:0;padding:0.01em 0 0 0;margin:0;min-width:0;} 
          .formkit-form[data-uid="be4036594b"] body:not(:-moz-handler-blocked) fieldset{display:table-cell;} 
          .formkit-form[data-uid="be4036594b"] h1,.formkit-form[data-uid="be4036594b"] h2,.formkit-form[data-uid="be4036594b"] h3,.formkit-form[data-uid="be4036594b"] h4,.formkit-form[data-uid="be4036594b"] h5,.formkit-form[data-uid="be4036594b"] h6{color:inherit;font-size:inherit;font-weight:inherit;} 
          .formkit-form[data-uid="be4036594b"] p{color:inherit;font-size:inherit;font-weight:inherit;} 
          .formkit-form[data-uid="be4036594b"] fieldset{padding:0;margin:0;border:none;} 
          .formkit-form[data-uid="be4036594b"] .formkit-input{background:#fff;padding:12px;border:1px solid #e3e3e3;border-radius:4px;flex:1 0 auto;line-height:1.4;margin:0;font-size:15px;transition:border-color ease-out 300ms;} 
          .formkit-form[data-uid="be4036594b"] .formkit-input:focus{outline:none;border-color:#1677be;} 
          .formkit-form[data-uid="be4036594b"] .formkit-submit{display:inline-block;padding:12px 24px;font-size:15px;font-weight:700;color:#fff;background-color:#1677be;border:none;border-radius:4px;cursor:pointer;position:relative;transition:background 200ms ease-in-out;} 
          .formkit-form[data-uid="be4036594b"] .formkit-submit:hover{background-color:#125a96;} 
          .formkit-form[data-uid="be4036594b"] .formkit-spinner{display:flex;flex-wrap:nowrap;position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;opacity:0;transition:opacity 300ms ease-in-out;} 
          .formkit-form[data-uid="be4036594b"] .formkit-submit[data-active] .formkit-spinner{opacity:1;} 
          .formkit-form[data-uid="be4036594b"] .formkit-submit[data-active] span{opacity:0;} 
          .formkit-form[data-uid="be4036594b"] .formkit-powered-by-convertkit-container{margin:10px 0;display:flex;justify-content:center;} 
          .formkit-form[data-uid="be4036594b"] .formkit-powered-by-convertkit{font-size:12px;color:#3d3d3d;text-decoration:none;} 
          /* End ConvertKit form styling */
          
          /* Hide ConvertKit success overlay - aggressive approach */
          .formkit-success-container,
          .formkit-success,
          [data-element="success"],
          .formkit-alert-success,
          .formkit-modal,
          .formkit-overlay,
          .formkit-popup,
          .seva-success,
          .seva-modal,
          .seva-overlay,
          div[style*="position: fixed"],
          div[style*="z-index"],
          .ck-modal,
          .ck-overlay,
          .convertkit-modal,
          .convertkit-overlay {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
          }
          
          /* Hide any dynamically created overlays */
          body > div[style*="position: fixed"]:not(.main-content),
          body > div[style*="z-index"]:not(.main-content) {
            display: none !important;
          }
          
          /* Inline fields side-by-side */
          .formkit-form[data-uid="be4036594b"] .formkit-fields {
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }
          .formkit-form[data-uid="be4036594b"] .formkit-input {
            background:#fff;
            padding:12px;
            border:1px solid #e3e3e3;
            border-radius:4px;
            flex:1 0 auto;
            line-height:1.4;
            margin:0;
            font-size:15px;
            transition:border-color ease-out 300ms;
          }
          .formkit-form[data-uid="be4036594b"] .formkit-submit {
            display:inline-block;
            padding:12px 24px;
            font-size:15px;
            font-weight:700;
            color:#fff;
            background-color:#1677be;
            border:none;
            border-radius:4px;
            cursor:pointer;
            position:relative;
            transition:background 200ms ease-in-out;
            flex: 0 0 auto;
            margin: 0;
          }
          /* Limit form width and center for default variant */
          .formkit-form[data-uid="be4036594b"] {
            max-width: 500px;
            margin: 0 auto;
          }
        </style>
      </form>
    </div>
    
    <!-- Features for default variant -->
    {variant === 'default' && (
      <div class="grid gap-4 sm:gap-6 md:grid-cols-3 mt-8 sm:mt-12">
        <div class="text-center">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-2 sm:mb-3">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-primary-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <h4 class="font-semibold text-gray-900 mb-1 sm:mb-2 text-sm sm:text-base">Weekly Summaries</h4>
          <p class="text-xs sm:text-sm text-gray-600">Get 2-3 new book summaries every week</p>
        </div>
        
        <div class="text-center">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-accent-100 rounded-full flex items-center justify-center mx-auto mb-2 sm:mb-3">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-accent-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <h4 class="font-semibold text-gray-900 mb-1 sm:mb-2 text-sm sm:text-base">Curated Content</h4>
          <p class="text-xs sm:text-sm text-gray-600">Handpicked bestsellers and trending books</p>
        </div>
        
        <div class="text-center">
          <div class="w-10 h-10 sm:w-12 sm:h-12 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-2 sm:mb-3">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-primary-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <h4 class="font-semibold text-gray-900 mb-1 sm:mb-2 text-sm sm:text-base">Exclusive Insights</h4>
          <p class="text-xs sm:text-sm text-gray-600">Bonus content and author interviews</p>
        </div>
      </div>
    )}
  </div>
</section>

<!-- Newsletter JavaScript for Kit Integration -->
<script>
  // Newsletter form handling - ready for Kit integration
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('newsletter-form');
    const statusDiv = document.getElementById('newsletter-status');
    const successMsg = document.getElementById('newsletter-success');
    const errorMsg = document.getElementById('newsletter-error');
    
    // Function to aggressively remove ConvertKit overlays
    function removeConvertKitOverlays() {
      const overlaySelectors = [
        '.formkit-success-container',
        '.formkit-success',
        '[data-element="success"]',
        '.formkit-alert-success',
        '.formkit-modal',
        '.formkit-overlay',
        '.formkit-popup',
        '.seva-success',
        '.seva-modal',
        '.seva-overlay',
        '.ck-modal',
        '.ck-overlay',
        '.convertkit-modal',
        '.convertkit-overlay'
      ];
      
      overlaySelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.remove();
        });
      });
      
      // Also remove any fixed position divs that might be overlays, but preserve our form
      const allDivs = document.querySelectorAll('div');
      allDivs.forEach(div => {
        const style = window.getComputedStyle(div);
        const isFormContainer = div.closest('[data-sv-form="8405196"]') || div.querySelector('[data-sv-form="8405196"]');
        const isCustomMessage = div.classList.contains('custom-success-message');
        
        if (!isFormContainer && !isCustomMessage && style.position === 'fixed' && 
            (style.zIndex > 1000 || div.textContent.includes('Thanks for subscribing'))) {
          div.remove();
        }
      });
      
      // Ensure our form stays visible
      const ourForm = document.querySelector('[data-sv-form="8405196"]');
      if (ourForm) {
        ourForm.style.display = '';
        ourForm.style.visibility = 'visible';
        ourForm.style.opacity = '1';
      }
    }
    
    // Run overlay removal periodically
    setInterval(removeConvertKitOverlays, 500);
    
    // Also run it on form submission
    const convertKitForm = document.querySelector('[data-sv-form="8405196"]');
    if (convertKitForm) {
      convertKitForm.addEventListener('submit', function() {
        // Hide overlays immediately and repeatedly
        setTimeout(removeConvertKitOverlays, 100);
        setTimeout(removeConvertKitOverlays, 500);
        setTimeout(removeConvertKitOverlays, 1000);
        setTimeout(removeConvertKitOverlays, 2000);
        
        // Show our custom success message after form submission
        setTimeout(() => {
          removeConvertKitOverlays();
          showCustomSuccessMessage();
          
          // Clear the form input but keep the form visible
          const emailInput = convertKitForm.querySelector('input[name="email_address"]');
          if (emailInput) {
            emailInput.value = '';
          }
          
          // Reset the submit button state
          const submitBtn = convertKitForm.querySelector('button[data-element="submit"]');
          if (submitBtn) {
            submitBtn.removeAttribute('data-active');
            const spinner = submitBtn.querySelector('.formkit-spinner');
            const span = submitBtn.querySelector('span');
            if (spinner) spinner.style.opacity = '0';
            if (span) span.style.opacity = '1';
          }
          
        }, 1500);
      });
    }
    
    // Function to show custom success message
    function showCustomSuccessMessage() {
      // Remove any existing custom messages
      const existingMessages = document.querySelectorAll('.custom-success-message');
      existingMessages.forEach(msg => msg.remove());
      
      // Create custom success message
      const successMessage = document.createElement('div');
      successMessage.className = 'custom-success-message';
      successMessage.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        font-weight: 500;
        max-width: 350px;
        animation: slideInRight 0.3s ease-out;
      `;
      successMessage.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <div>
            <div style="font-weight: 600;">Thanks for subscribing!</div>
            <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">Check your email to confirm your subscription.</div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.7; hover: opacity: 1;">Ã—</button>
        </div>
      `;
      
      // Add animation styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(successMessage);
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (successMessage.parentElement) {
          successMessage.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => successMessage.remove(), 300);
        }
      }, 5000);
    }
    
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = form.querySelector('input[name="email"]').value;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.textContent = 'Subscribing...';
        submitBtn.disabled = true;
        
        try {
          // ConvertKit (Kit) integration
          // Replace FORM_ID below with your actual ConvertKit form ID
          const FORM_ID = 'placeholder'; // <-- Replace with your form ID
          const API_KEY = 'placeholder';
          const endpoint = `https://api.convertkit.com/v3/forms/${FORM_ID}/subscribe`;

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
              api_key: API_KEY
            })
          });

          if (response.ok) {
            // Show success message
            statusDiv.classList.remove('hidden');
            successMsg.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            form.reset();
          } else {
            throw new Error('Subscription failed');
          }
          
        } catch (error) {
          console.error('Newsletter subscription error:', error);
          statusDiv.classList.remove('hidden');
          errorMsg.classList.remove('hidden');
          successMsg.classList.add('hidden');
        } finally {
          // Reset button
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });
    }
  });
</script>

<style>
  /* Custom styles for newsletter component */
  .newsletter-section input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .newsletter-section .btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  .newsletter-section .btn-primary:disabled:hover {
    transform: none;
  }
</style>
