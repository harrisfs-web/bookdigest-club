---
/*  ADD THIS import so Astro bundles the file  */
import "../styles/global.css";
import SearchPopover from "../components/SearchPopover.astro";

const defaultDescription = "AI-powered concise book summaries & recommendations.";
const { title = "BookDigest", description = defaultDescription } = Astro.props;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K87VK2MC');</script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="description" content={description} />
    
  <!-- Canonical & robots -->
  <link rel="canonical" href={`https://bookdigest.club${Astro.url.pathname}`} />
  <meta name="robots" content="index, follow, max-image-preview:large" />

    <!-- Google Fonts -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <!-- Basic Open Graph -->
    <meta property="og:type"        content="website" />
    <meta property="og:site_name"   content="BookDigest" />
  <meta property="og:title"       content={title} />
  <meta property="og:description" content={description} />
    <meta property="og:image"       content="https://bookdigest.club/og-default.jpg" />
  <meta property="og:url"         content={`https://bookdigest.club${Astro.url.pathname}`} />

    <!-- Twitter Card -->
    <meta name="twitter:card"        content="summary_large_image" />
    <meta name="twitter:title"       content={title} />
  <meta name="twitter:description" content={description} />
    <meta name="twitter:image"       content="https://bookdigest.club/og-default.jpg" />
    
    <!-- Organization Logo Structured Data for Google -->
    <script type="application/ld+json">
      {"@context": "https://schema.org",
       "@type": "Organization",
       "name": "BookDigest Club",
       "url": "https://bookdigest.club/",
       "logo": "https://bookdigest.club/logo.png"}
    </script>

  <!-- Page-specific head content (e.g., JSON-LD) -->
  <slot name="head" />
  </head>

  <script>
    window.dataLayer = window.dataLayer || [];
    window.bd = {
      track(eventName, params = {}) {
        const payload = { event: eventName, ...params };
        window.dataLayer.push(payload);
        return payload;
      }
    };

    // Robust delegated handler:
    // - handles text-node clicks
    // - uses pointerdown so we push before navigation
    // - delays navigation a short time for links so GTM can run in Preview
    document.addEventListener('pointerdown', (e) => {
      try {
        // Normalize element (if text node, use parentElement)
        let target = e.target;
        if (target && target.nodeType === 3 && target.parentElement) {
          target = target.parentElement;
        }
        const el = target && target.closest ? target.closest('[data-gtm-event]') : null;
        if (!el) return;

        const eventName = el.getAttribute('data-gtm-event');
        const clickContent = el.getAttribute('data-click-content') || (el.textContent || '').trim();

        // If it's a link, prevent immediate navigation, push event, then follow the link.
        if (el.tagName === 'A' && el.href) {
          e.preventDefault();
          window.bd.track(eventName, { click_content: clickContent });
          setTimeout(() => { window.location.href = el.href; }, 150);
        } else {
          window.bd.track(eventName, { click_content: clickContent });
        }
      } catch (err) {
        // avoid breaking the page if something unexpected happens
        console.warn('bd track error', err);
      }
    }, { passive: false });
  </script>

  <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-sans">
  <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K87VK2MC"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Navigation Header -->
    <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50">
      <nav class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <a href="/" class="flex items-center space-x-2 text-2xl font-bold text-primary-700 hover:text-primary-800 transition-colors" data-gtm-event="menu_click" data-click-content="Home">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
            <span>BookDigest</span>
          </a>
          <div class="flex items-center space-x-6">
            <a href="/books" class="text-gray-600 hover:text-primary-600 font-medium transition-colors" data-gtm-event="menu_click" data-click-content="All Books">All Books</a>
            <a href="/about" class="text-gray-600 hover:text-primary-600 font-medium transition-colors" data-gtm-event="menu_click" data-click-content="About">About</a>
             <SearchPopover />
           </div>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 mt-20">
      <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="text-center">
          <p class="text-sm">&copy; 2025 BookDigest. AI-powered book summaries for busy readers.</p>
        </div>
      </div>
    </footer>
  </body>
</html>